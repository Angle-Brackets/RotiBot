apiVersion: v1
kind: ConfigMap
metadata:
  name: lavalink-config
data:
  application.yml: |
    server:
      port: 2333
      address: 0.0.0.0
      http2:
        enabled: false

    plugins:
      youtube:
        enabled: true 
        oauthConfig:
          enabled: true
        allowSearch: true 
        allowDirectVideoIds: true 
        allowDirectPlaylistIds: true 
        clients:
          - MUSIC
          - WEB
          - ANDROID_TESTSUITE
          - TVHTML5EMBEDDED
          - ANDROID_LITE
          - MEDIA_CONNECT
          - IOS
        TVHTML5EMBEDDED:
          playlistLoading: false 
          videoLoading: false 
          searching: false
        oauth:
          enabled: true
          refreshToken: "${YOUTUBE_REFRESH_TOKEN}"

    lavalink:
      plugins:  
        - dependency: "dev.lavalink.youtube:youtube-plugin:1.16.0"
          snapshot: false
        - dependency: "com.github.topi314.lavasrc:lavasrc-plugin:4.3.0"
          snapshot: false
      server:
        password: "${MUSIC_PASS}"
        sources:
          youtube: false
          bandcamp: true
          soundcloud: true
          twitch: true
          vimeo: true
          nico: true
          http: true
          local: false
        filters:
          volume: true
          equalizer: true
          karaoke: true
          timescale: true
          tremolo: true
          vibrato: true
          distortion: true
          rotation: true
          channelMix: true
          lowPass: true
        nonAllocatingFrameBuffer: false
        bufferDurationMs: 400
        frameBufferDurationMs: 5000
        opusEncodingQuality: 10
        resamplingQuality: LOW
        trackStuckThresholdMs: 10000
        useSeekGhosting: true
        youtubePlaylistLoadLimit: 6
        playerUpdateInterval: 5
        youtubeSearchEnabled: true
        soundcloudSearchEnabled: true
        gc-warnings: true

    metrics:
      prometheus:
        enabled: false
        endpoint: /metrics

    sentry:
      dsn: ""
      environment: ""

    logging:
      file:
        path: ./logs/
      level:
        root: INFO
        lavalink: INFO
      request:
        enabled: true
        includeClientInfo: true
        includeHeaders: false
        includeQueryString: true
        includePayload: true
        maxPayloadLength: 10000
      logback:
        rollingpolicy:
          max-file-size: 1GB
          max-history: 30
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lavalink
  labels:
    app: lavalink
spec:
  replicas: 1
  selector:
    matchLabels:
      app: lavalink
  template:
    metadata:
      labels:
        app: lavalink
    spec:
      containers:
      - name: lavalink
        image: fredboat/lavalink:latest
        ports:
        - containerPort: 2333
          name: lavalink
        env:
        - name: MUSIC_PASS
          valueFrom:
            secretKeyRef:
              name: rotibot-secrets
              key: MUSIC_PASS
        - name: YOUTUBE_REFRESH_TOKEN
          valueFrom:
            secretKeyRef:
              name: rotibot-secrets
              key: YOUTUBE_REFRESH_TOKEN
        volumeMounts:
        - name: config
          mountPath: /opt/Lavalink/application.yml
          subPath: application.yml
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      volumes:
      - name: config
        configMap:
          name: lavalink-config
---
apiVersion: v1
kind: Service
metadata:
  name: lavalink
  labels:
    app: lavalink
spec:
  type: ClusterIP
  ports:
  - port: 2333
    targetPort: 2333
    protocol: TCP
    name: lavalink
  selector:
    app: lavalink