name: Deploy RotiBot to GKE

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}
  IMAGE: rotibot

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        install_components: 'gke-gcloud-auth-plugin'

    - name: Configure Docker to use gcloud
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials "$GKE_CLUSTER" --zone "$GKE_ZONE"
      env:
        USE_GKE_GCLOUD_AUTH_PLUGIN: 'True'

    - name: Build Docker image
      run: |
        docker build -t "us-central1-docker.pkg.dev/$PROJECT_ID/rotibot/rotibot:$GITHUB_SHA" \
          -t "us-central1-docker.pkg.dev/$PROJECT_ID/rotibot/rotibot:latest" .

    - name: Push Docker image
      run: |
        docker push "us-central1-docker.pkg.dev/$PROJECT_ID/rotibot/rotibot:$GITHUB_SHA"
        docker push "us-central1-docker.pkg.dev/$PROJECT_ID/rotibot/rotibot:latest"

    - name: Create/Update secrets in GKE
      run: |
        kubectl create secret generic rotibot-secrets \
          --from-literal=TOKEN="${{ secrets.TOKEN }}" \
          --from-literal=MUSIC_PASS="${{ secrets.MUSIC_PASS }}" \
          --from-literal=APPLICATION_ID="${{ secrets.APPLICATION_ID }}" \
          --from-literal=DATABASE="${{ secrets.DATABASE }}" \
          --from-literal=MUSIC_IP="${{ secrets.MUSIC_IP }}" \
          --from-literal=TEST_TOKEN="${{ secrets.TEST_TOKEN }}" \
          --from-literal=TEST_APPLICATION_ID="${{ secrets.TEST_APPLICATION_ID }}" \
          --from-literal=YOUTUBE_NAME="${{ secrets.YOUTUBE_NAME }}" \
          --from-literal=YOUTUBE_PASS="${{ secrets.YOUTUBE_PASS }}" \
          --from-literal=YOUTUBE_REFRESH_TOKEN="${{ secrets.YOUTUBE_REFRESH_TOKEN }}" \
          --dry-run=client -o yaml | kubectl apply -f -

    - name: Update deployment manifests with project ID
      run: |
        sed -i "s|PROJECT_ID|$PROJECT_ID|g" k8s/deployment.yaml

    - name: Deploy to GKE
      run: |
        kubectl apply -f k8s/lavalink-deployment.yaml
        kubectl apply -f k8s/deployment.yaml
        kubectl rollout status deployment/lavalink
        kubectl rollout status deployment/rotibot
        kubectl get services -o wide